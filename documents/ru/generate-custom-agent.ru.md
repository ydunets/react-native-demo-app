# Создание пользовательских агентов для GitHub Copilot

Полное руководство по созданию специализированных AI-агентов в VS Code, которые принимают различные роли в соответствии с конкретными задачами разработки.

## Что такое пользовательские агенты?

Пользовательские агенты позволяют настроить GitHub Copilot на принятие различных ролей со специализированным поведением, инструментами и инструкциями. В отличие от обычного чата, пользовательские агенты предварительно настроены для конкретных задач:

- **Ревьюер безопасности**: Фокусируется на выявлении уязвимостей и рекомендациях по безопасности
- **Планировщик**: Генерирует подробные планы реализации с инструментами только для чтения
- **Архитектор решений**: Предоставляет рекомендации архитектуры и проектирования системы
- **Ревьюер кода**: Сосредоточен на качестве кода, производительности и поддерживаемости
- **Агент реализации**: Полные возможности редактирования с инструкциями по генерации кода

Каждый агент имеет собственную конфигурацию, что позволяет быстро переключаться между специализированными режимами без необходимости ручной переконфигурации инструментов и инструкций.

## Почему использовать пользовательские агенты?

### Возможности, специфичные для задачи
Разные задачи требуют разные наборы инструментов. Агент планирования может использовать только инструменты только для чтения (search, fetch, githubRepo), чтобы предотвратить случайные изменения, в то время как агент реализации нуждается в полных возможностях редактирования.

### Последовательное, специализированное поведение
Пользовательские агенты кодируют специализированные инструкции, обеспечивающие последовательные, подходящие для задачи ответы. После настройки вы переключаетесь на агента и сразу же получаете правильный менталитет и возможности.

### Многошаговые рабочие процессы с Handoffs
Используйте handoffs для создания управляемых рабочих процессов, которые переходят между агентами с предварительно заполненными подсказками и контекстом:
- **Планирование → Реализация**: Генерируйте план, затем передайте его на реализацию
- **Реализация → Проверка**: Завершите код, затем перейдите в агент проверки кода
- **TDD**: Создавайте падающие тесты, затем передайте для их успешной реализации

## Структура файла и местоположение

### Создание пользовательского агента

1. **В VS Code** выберите **Configure Custom Agents** из выпадающего меню агентов
2. Нажмите **Create new custom agent** (или используйте Command Palette: `Chat: New Custom Agent`)
3. Выберите местоположение:
   - **Workspace**: папка `.github/agents/` (общая с командой)
   - **User Profile**: Используется во всех ваших рабочих пространствах (личное)
4. Введите имя файла (становится названием агента по умолчанию)
5. Заполните файл `.agent.md` с YAML frontmatter и инструкциями

### Формат файла

Пользовательские агенты используют файлы Markdown `.agent.md` с двумя разделами:

```markdown
---
[YAML Frontmatter - Конфигурация]
---
[Markdown Body - Инструкции и руководства]
```

## Справочник YAML Frontmatter

### Обязательные и общие поля

| Поле | Тип | Описание |
|------|-----|---------|
| `description` | string | Краткое описание, показываемое как заполнитель в поле ввода чата |
| `name` | string | Отображаемое имя агента (по умолчанию: имя файла, если не указано) |
| `tools` | array | Список доступных инструментов для этого агента |
| `argument-hint` | string | Опциональный текст подсказки в поле ввода чата |
| `model` | string | AI модель для использования (например, `Claude Sonnet 4`) |

### Дополнительные поля

| Поле | Тип | Описание |
|------|-----|---------|
| `handoffs` | array | Управляемые переходы к другим агентам с предложениями |
| `infer` | boolean | Включить агент как подагент (по умолчанию: true) |
| `target` | string | Окружение: `vscode` или `github-copilot` |
| `mcp-servers` | array | Конфигурации MCP серверов для target: github-copilot |

## Конфигурация инструментов

### Доступные категории инструментов

**Инструменты только для чтения** (для планирования/анализа):
- `search` — Поиск в кодовой базе по шаблонам
- `fetch` — Получение содержимого файлов
- `githubRepo` — Доступ к информации репозитория GitHub
- `usages` — Поиск использования символов

**Инструменты редактирования** (для реализации):
- Все инструменты только для чтения, плюс:
- `createFile` — Создание новых файлов
- `editFiles` — Изменение существующих файлов
- `runInTerminal` — Выполнение команд

**Специализированные инструменты**:
- `problems` — Ошибки проверки кода/компиляции
- `testFailure` — Детали сбоев тестов
- `changes` — Изменения Git

### Указание инструментов

```yaml
---
tools:
  - 'search'
  - 'fetch'
  - 'githubRepo'
---
```

Для MCP серверов включите все инструменты:
```yaml
tools:
  - 'mcp-server-name/*'
```

### Приоритет списка инструментов

При работе с файлом подсказок + пользовательский агент:
1. Инструменты, указанные в файле подсказки (наивысший приоритет)
2. Инструменты из упомянутого пользовательского агента
3. Инструменты по умолчанию для выбранного агента (наинизший приоритет)

## Handoffs: создание управляемых рабочих процессов

Handoffs создают интерактивные кнопки, которые направляют пользователей на следующий шаг в рабочем процессе с контекстом и предварительно заполненными подсказками.

### Определение Handoffs

```yaml
---
description: Генерирование плана реализации
tools: ['search', 'fetch']
handoffs:
  - label: Начать реализацию
    agent: implementation
    prompt: Теперь реализуйте план, описанный выше.
    send: false
  - label: Создать тесты
    agent: testing
    prompt: Напишите модульные тесты для реализации.
    send: false
---
```

### Поля Handoff

| Поле | Тип | Описание |
|------|-----|---------|
| `label` | string | Текст кнопки, показываемый пользователю |
| `agent` | string | Идентификатор целевого агента/имя файла |
| `prompt` | string | Предварительно заполненное сообщение для следующего шага |
| `send` | boolean | Автоматически отправить подсказку (по умолчанию: false) |

### Общие шаблоны рабочих процессов

**Конвейер качества кода**:
План → Реализация → Тестирование → Проверка

**Разработка функций**:
План → Реализация → Написание тестов → Проверка кода

**Проверка безопасности**:
Аудит безопасности → Исправление проблем → Проверка исправлений

## Markdown Body: инструкции и руководства

Body - это место, где вы определяете поведение агента. Используйте форматирование Markdown с:

### Лучшие практики структуры

1. **Определение роли**: Четко сформулируйте цель агента
2. **Основные инструкции**: Рекомендации высокого уровня
3. **Категории**: Организуйте по ответственности (например, "## Стратегия тестирования")
4. **Примеры**: Предоставьте примеры кода, показывающие ожидаемый результат
5. **Антипаттерны**: Документируйте, чего избегать

### Пример структуры

```markdown
---
description: Генерирование подробных планов реализации
name: Планировщик
tools: ['search', 'fetch', 'githubRepo']
---
# Агент планирования

Вы опытный архитектор программного обеспечения, создающий подробные планы реализации.

## Ваша роль
Генерируйте комплексные, пошаговые планы реализации без написания кода.

## Основные принципы
- Тщательно анализируйте проблемное пространство
- Разбивайте на управляемые задачи
- Выявляйте технические риски
- Предлагайте стратегии тестирования

## Формат плана
- Обзор: Сводка высокого уровня
- Требования: Что необходимо выполнить
- Шаги реализации: Детальные, последовательные задачи
- Риски и смягчение: Потенциальные проблемы
- Тестирование: Подход к проверке
```

### Ссылки на внешние файлы

Включайте инструкции из отдельных файлов, используя Markdown ссылки:

```markdown
# Расширенные инструкции

Смотрите [Руководство по интеграции API](api-integration.instructions.md) для шаблонов endpoints.
Смотрите [Шаблоны компонентов](components.instructions.md) для соглашений UI.
```

### Ссылки на инструменты в инструкциях

Используйте синтаксис `#tool:<tool-name>` для выделения доступных инструментов:

```markdown
Используйте #tool:githubRepo для изучения существующих шаблонов в кодовой базе.
Используйте #tool:search для поиска похожих реализаций.
```

## Полные примеры агентов

### Пример 1: Агент планирования

```markdown
---
description: Генерирование плана реализации
name: Планировщик
tools: ['search', 'fetch', 'githubRepo', 'usages']
model: Claude Sonnet 4
handoffs:
  - label: Начать реализацию
    agent: implementation
    prompt: Теперь реализуйте план, описанный выше.
    send: false
  - label: Создать тесты
    agent: testing
    prompt: Напишите тесты для этой реализации.
    send: false
---
# Агент планирования

Вы старший архитектор, которому поручено создание подробных планов реализации.

## Ваши обязанности
- Анализируйте требования и контекст проекта
- Разбивайте функции на управляемые задачи
- Выявляйте технические решения и компромиссы
- Предлагайте стратегии тестирования и развертывания
- Документируйте риски и подходы к их смягчению

## Формат вывода плана
Используйте эту структуру для каждого плана:
1. **Обзор**: Сводка из 2-3 предложений
2. **Требования**: Маркированный список того, что необходимо выполнить
3. **Архитектура**: Ключевые решения по проектированию
4. **Шаги реализации**: 3-8 нумерованных, подробных шагов
5. **Стратегия тестирования**: Необходимые модульные, интеграционные, end-to-end тесты
6. **Риски и смягчение**: Потенциальные проблемы и способы их решения
7. **Зависимости**: Внешние требования или блокирующие факторы

## Доступные инструменты
Используйте #tool:githubRepo для изучения структуры кодовой базы.
Используйте #tool:search для поиска существующих реализаций, на которых можно построить.
Используйте #tool:fetch для проверки соответствующей документации.
```

### Пример 2: Агент проверки безопасности

```markdown
---
description: Аудит кода на уязвимости безопасности
name: Ревьюер безопасности
tools: ['search', 'fetch', 'problems']
model: Claude Sonnet 4
---
# Агент ревьюера безопасности

Вы эксперт по безопасности, которому поручено выявление уязвимостей и обеспечение безопасного кодирования.

## Области фокусировки
1. **Аутентификация и авторизация**: Обработка сеансов, валидация токенов
2. **Защита данных**: Шифрование, утечка чувствительных данных
3. **Атаки инъекций**: SQL-инъекции, инъекции команд, XSS
4. **Контроль доступа**: Проверки разрешений, повышение привилегий
5. **Криптография**: Слабые алгоритмы, плохая генерация случайных чисел
6. **Безопасность API**: Ограничение частоты, валидация входных данных, кодирование выходных данных

## Процесс проверки
1. Выявите уязвимые шаблоны
2. Оцените серьезность: КРИТИЧЕСКАЯ, ВЫСОКАЯ, СРЕДНЯЯ, НИЗКАЯ
3. Объясните риск с примерами
4. Предложите безопасные альтернативы
5. Рекомендуйте подходы к тестированию

## Частые уязвимости для проверки
- Жестко закодированные учетные данные или API ключи
- Отсутствующая валидация входных данных
- Небезопасная десериализация
- Слабое хеширование пароля
- Отсутствующие CSRF токены
- Небезопасные прямые ссылки на объекты
```

### Пример 3: Агент реализации

```markdown
---
description: Написание production-ready кода
name: Агент реализации
tools: ['search', 'fetch', 'createFile', 'editFiles', 'githubRepo']
model: Claude Sonnet 4
handoffs:
  - label: Тестирование реализации
    agent: testing
    prompt: Напишите полные тесты для этой реализации.
    send: false
---
# Агент реализации

Вы старший инженер программного обеспечения, которому поручено реализация функций и исправлений.

## Стандарты кодирования
- Следуйте соглашениям проекта из существующего кода
- Добавляйте подробные комментарии для сложной логики
- Явно обрабатывайте ошибки
- Пишите оборонительный код
- Оптимизируйте для читаемости в первую очередь, производительности во вторую

## Контрольный список реализации
- [ ] Тщательно изучите план
- [ ] Проверьте существующие похожие реализации
- [ ] Следуйте соглашениям об именах проекта
- [ ] Добавьте обработку ошибок
- [ ] Добавьте комментарии для сложных разделов
- [ ] Рассмотрите граничные случаи
- [ ] Проверьте соответствие исходным требованиям
```

## Дополнительные возможности

### Подагенты (Экспериментально)

Включите пользовательские агенты для запуска в качестве подагентов, установив `infer: true` (по умолчанию). Подагенты могут:
- Работать в фоне над сложными задачами
- Наследовать те же инструменты и инструкции
- Сообщать результаты обратно в основной чат

```yaml
---
name: Агент реализации
infer: true  # Может использоваться как подагент
tools: ['createFile', 'editFiles']
---
```

### Выбор модели

Укажите, какую AI модель использовать:

```yaml
---
model: Claude Sonnet 4  # Быстрый и способный
# или
model: Claude 3.5 Opus  # Наиболее способный, медленнее
---
```

### MCP серверы (GitHub Copilot)

Для облачных агентов настройте MCP серверы:

```yaml
---
target: github-copilot
mcp-servers:
  - server-name: "my-database"
    config:
      host: "localhost"
      port: 5432
---
```

## Обмен агентами в командах

### Уровень рабочего пространства (командное совместное использование)
Создайте агентов в папке `.github/agents/` и зафиксируйте в управлении версиями. Все члены команды автоматически получают агентов.

### Уровень организации (Enterprise)
Создайте агентов на уровне организации GitHub. VS Code автоматически их обнаруживает, когда:
- `github.copilot.chat.customAgents.showOrganizationAndEnterpriseAgents` установлена в `true`
- У вас есть доступ к организации

## Лучшие практики

### 1. Четкая, сфокусированная цель
Каждый агент должен иметь одну основную ответственность:
- ✅ "Агент плана для архитектурного проектирования"
- ❌ "Универсальный агент, который все делает"

### 2. Минимальный набор инструментов
Включайте только инструменты, необходимые агенту:
- ✅ Агент планирования: инструменты только для чтения (`search`, `fetch`)
- ❌ Агент планирования: инструменты редактирования (предотвращает случайные изменения)

### 3. Подробные инструкции
Предоставьте конкретные, действенные рекомендации:
- ✅ "Генерируйте план с: Обзор, Требования, Шаги, Тестирование, Риски"
- ❌ "Создайте план"

### 4. Примеры в инструкциях
Покажите ожидаемый формат выходных данных и тон:
- ✅ Включайте структуру примера плана или примеры кода
- ❌ Только опишите ожидания в прозе

### 5. Используйте преимущества Handoffs
Создайте естественные переходы рабочего процесса:
- ✅ План → Реализация → Тестирование → Проверка
- ❌ Свалите все задачи на один агент

### 6. Сначала протестируйте агентов локально
Перед совместным использованием:
- Создайте агента в рабочем пространстве
- Протестируйте с реальными задачами
- Итерируйте инструкции
- Делитесь, когда это доказано эффективным

### 7. Документируйте ограничения инструментов
Явно упоминайте, что могут и не могут делать агенты:
- "Этот агент создает файлы, но не запускает тесты"
- "Этот агент проверяет код, но не вносит изменения"

## Устранение неполадок

### Агент не отображается в выпадающем меню
- Убедитесь, что файл находится в папке `.github/agents/`
- Проверьте расширение `.agent.md` (не `.md`)
- Перезагрузите VS Code
- Проверьте, скрыт ли агент через Configure Custom Agents

### Инструмент не работает
- Проверьте орфографию имени инструмента
- Проверьте, доступен ли инструмент в вашей версии VS Code
- Некоторые инструменты требуют установленные расширения
- Если инструмент недоступен, он молча игнорируется

### Инструкции не применяются
- Инструкции добавляются в начало подсказки пользователя
- Проверьте Agent Debug View, чтобы увидеть отправленную подсказку
- Проверьте синтаксис YAML frontmatter

### Handoffs не отображаются
- Убедитесь, что целевой агент существует
- Проверьте синтаксис YAML handoff
- Пользователь должен завершить ответ чата перед появлением кнопок
- `send: false` показывает кнопку, `send: true` автоматически отправляет

## Миграция с Chat Modes

Если у вас есть старые файлы `.chatmode.md` в `.github/chatmodes/`:
- VS Code все еще их распознает как пользовательские агенты
- Используйте Quick Fix для миграции на новый формат `.agent.md` в `.github/agents/`
- Функциональность остается той же, только соглашение об именовании изменилось

## Связанные ресурсы

- [Пользовательские инструкции](https://code.visualstudio.com/docs/copilot/customization/custom-instructions) — Универсальные руководства для всех чатов
- [Файлы подсказок](https://code.visualstudio.com/docs/copilot/customization/prompt-files) — Многоразовые подсказки для конкретных задач
- [Инструменты в чате](https://code.visualstudio.com/docs/copilot/chat/chat-tools) — Полный справочник доступных инструментов
- [Awesome Copilot](https://github.com/github/awesome-copilot) — Агенты и примеры, предоставленные сообществом
- [Документация VS Code Copilot](https://code.visualstudio.com/docs/copilot) — Официальный справочник

## Быстрый контрольный список создания агента

- [ ] Создайте файл `.agent.md` в папке `.github/agents/`
- [ ] Добавьте `description` и `name` в YAML frontmatter
- [ ] Выберите подходящие `tools` для целей агента
- [ ] Напишите четкие инструкции в Markdown body
- [ ] Включайте примеры или ожидаемый формат выходных данных
- [ ] Добавьте `handoffs` для многошаговых рабочих процессов, если применимо
- [ ] Протестируйте агента с реалистичными сценариями
- [ ] Делитесь с командой путем фиксации в `.github/agents/`
- [ ] Документируйте цель и варианты использования агента
