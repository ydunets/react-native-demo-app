# Документация сценариев загрузки файлов

Данная документация описывает три ключевых сценария загрузки файлов в приложении React Native/Expo с функциональностью очереди загрузки вложений.

## Обзор сценариев

### [Сценарий 1: Базовая загрузка файлов через очередь](./scenario-1-basic-queue.md)
**Базовая последовательная обработка файлов через управляемую систему очередей**
- Инициализация очереди и дедупликация файлов
- Последовательная обработка загрузки с отслеживанием прогресса
- Управление кешем и обработка завершения
- Восстановление после ошибок и обработка сетевых условий

### [Сценарий 2: Загрузка файлов при переходе в фоновый/основной режим](./scenario-2-background-foreground.md)
**Поведение загрузки файлов во время переходов состояния приложения**
- Автоматическая приостановка загрузок при переходе приложения в фон
- Сохранение состояния с использованием постоянного хранилища MMKV
- Беспрепятственное возобновление при возврате на передний план
- Управление ресурсами и эффективность батареи

### [Сценарий 3: Ускоренная загрузка через вложения сообщений](./scenario-3-accelerated-loading.md)
**Механизм приоритетной загрузки для немедленного доступа к файлам**
- Стратегия "кеш-первый" для мгновенного открытия файлов
- Приостановка очереди и обработка приоритетной загрузки
- Автоматическое возобновление очереди после завершения
- Обработка приоритетов, инициированная пользователем

## Техническая архитектура

### Ключевые компоненты
- **Управление очередью**: `stores/downloadQueue/downloadQueueStore.ts`
- **Отслеживание прогресса**: `stores/downloadProgress/downloadProgressStore.ts`
- **Мониторинг состояния приложения**: `hooks/useAppState.tsx`
- **Файловые операции**: `lib/files.ts` (Expo File System v17+)
- **Координация загрузки**: `hooks/useDownloadMessageAttachments.tsx`

### Основные функции
- **Постоянная очередь**: Zustand + MMKV для постоянства между сессиями
- **Умное кеширование**: Дедупликация на основе имени файла и проверка кеша
- **Система приоритетов**: Немедленные загрузки, инициированные пользователем, обходят очередь
- **Обработка фона**: Автоматическая пауза/возобновление на основе состояния приложения
- **Аутентификация**: Инъекция Bearer токена для безопасного доступа к файлам

## Особенности реализации

### Поток обработки очереди
```
Запрос файла → Проверка кеша → Добавление в очередь → Последовательная обработка
      ↓              ↓               ↓                         ↓
Приоритет → Немедленное открытие → Фоновый процесс → Обновления прогресса
```

### Управление состоянием
- **Глобальное состояние**: Постоянная очередь загрузки и отслеживание прогресса
- **Локальное состояние**: Управление очередью обработки с React refs
- **Состояние приложения**: Мониторинг в реальном времени с автоматической паузой/возобновлением

### Сетевая оптимизация
- Загрузка одного файла за раз для предотвращения перегрузки устройства
- Инъекция токена аутентификации для безопасного доступа к API
- Обратные вызовы прогресса с обратной связью пользователя в реальном времени
- Осведомленность о сетевых условиях с правильной обработкой ошибок

## Случаи использования

### Нормальная обработка очереди
Идеально подходит для пакетной загрузки множественных файлов, где пользователь может ждать последовательного завершения.

### Прерывание фоном
Обрабатывает реальные сценарии, когда пользователи переключают приложения или блокируют устройство во время загрузок.

### Немедленный доступ
Обеспечивает мгновенное удовлетворение, когда пользователям нужны конкретные файлы немедленно, независимо от статуса очереди.

---

**Связанная документация:**
- [Техническое руководство по загрузке вложений](../download-attachments/)
- [Документация интеграции API](../../api/)
- [Паттерны управления состоянием](../../stores/)